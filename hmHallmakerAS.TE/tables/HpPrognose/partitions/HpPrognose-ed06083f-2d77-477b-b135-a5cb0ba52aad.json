{
  "name": "HpPrognose-ed06083f-2d77-477b-b135-a5cb0ba52aad",
  "mode": "import",
  "queryGroup": "Dimensjoner",
  "source": {
    "type": "m",
    "expression": [
      "let",
      "    Source = Table.NestedJoin(DatesFromProjects,{\"HovedArbeidProsjektNr\"},DatesFromForecast,{\"Hovedarbeidsprosjekt\"},\"DatesFromForecast\",JoinKind.RightOuter),",
      "    #\"Expanded DatesFromForecast\" = Table.ExpandTableColumn(Source, \"DatesFromForecast\", {\"Start\", \"Slutt\", \"Dato\"}, {\"Start.1\", \"Slutt.1\", \"Date\"}),",
      "    #\"Added Custom2\" = Table.AddColumn(#\"Expanded DatesFromForecast\", \"CStart\", each ",
      "\tif [Start] = null ",
      "\tthen ",
      "\t\tif [Start.1] = null ",
      "\t\tthen Date.StartOfMonth(DateTime.Date(DateTime.LocalNow()))",
      "\t\telse [Start.1]",
      "\telse [Start], type date),",
      "    #\"Added Custom3\" = Table.AddColumn(#\"Added Custom2\", \"CSlutt\", each if Number.From(",
      "\t\tif Number.From([Slutt.1]) = null ",
      "\t\tthen ",
      "\t\t\tif Number.From([Slutt]) = null ",
      "\t\t\tthen DateTime.Date(DateTime.LocalNow())",
      "\t\t\telse [Slutt]",
      "\t\telse [Slutt.1]",
      "\t\t)\t< Number.From(DateTime.Date(DateTime.LocalNow())) ",
      "\tthen Date.EndOfMonth(DateTime.Date(DateTime.LocalNow()))",
      "\telse ",
      "\t\tif Number.From([Slutt.1]) = null ",
      "\t\tthen ",
      "\t\t\tif Number.From([Slutt]) = null ",
      "\t\t\tthen Date.EndOfMonth(DateTime.Date(DateTime.LocalNow()))",
      "\t\t\telse [Slutt]",
      "\t\telse [Slutt.1], type date),",
      "    #\"Removed Columns1\" = Table.RemoveColumns(#\"Added Custom3\",{\"Start\", \"Slutt\", \"Start.1\", \"Slutt.1\"}),",
      "    #\"Renamed Columns1\" = Table.RenameColumns(#\"Removed Columns1\",{{\"CStart\", \"Start\"}, {\"CSlutt\", \"Slutt\"}}),",
      "    #\"Added Custom\" = Table.AddColumn(#\"Renamed Columns1\", \"ListOfDates\", each List.Transform({Number.From([Date])..Number.From([Slutt])},each Date.From(_))),",
      "    #\"Expanded ListOfDates\" = Table.ExpandListColumn(#\"Added Custom\", \"ListOfDates\"),",
      "    #\"Inserted Start of Month\" = Table.AddColumn(#\"Expanded ListOfDates\", \"Dato\", each Date.StartOfMonth([ListOfDates]), type date),",
      "    #\"Removed Columns\" = Table.RemoveColumns(#\"Inserted Start of Month\",{\"ListOfDates\", \"Date\"}),",
      "    #\"Removed Duplicates\" = Table.Distinct(#\"Removed Columns\", {\"HovedArbeidProsjektNr\", \"Start\", \"Slutt\", \"Dato\"}),",
      "    #\"Added Custom1\" = Table.AddColumn(#\"Removed Duplicates\", \"Varighet\", each Number.From([Slutt])-Number.From([Start])+1),",
      "    #\"Changed Type\" = Table.TransformColumnTypes(#\"Added Custom1\",{{\"HovedArbeidProsjektNr\", type text}, {\"Varighet\", Int64.Type}}),",
      "    #\"Merged Queries\" = Table.NestedJoin(#\"Changed Type\",{\"HovedArbeidProsjektNr\", \"Dato\"},ProjectForecast,{\"Hovedarbeidsprosjekt\", \"Date\"},\"ForecastFromForecast\",JoinKind.LeftOuter),",
      "    #\"Expanded ForecastFromForecast\" = Table.ExpandTableColumn(#\"Merged Queries\", \"ForecastFromForecast\", {\"CostAcc\", \"RevenueAcc\"}, {\"CostAcc\", \"RevenueAcc\"}),",
      "    #\"Renamed Columns\" = Table.RenameColumns(#\"Expanded ForecastFromForecast\",{{\"CostAcc\", \"Kostnader\"}, {\"RevenueAcc\", \"Inntekter\"}}),",
      "    #\"Sorted Rows\" = Table.Sort(#\"Renamed Columns\",{{\"HovedArbeidProsjektNr\", Order.Ascending}, {\"Dato\", Order.Ascending}}),",
      "    #\"Filled Down\" = Table.FillDown(#\"Sorted Rows\",{\"Inntekter\", \"Kostnader\"}),",
      "    #\"Filtered Rows\" = Table.SelectRows(#\"Filled Down\", each ([HovedArbeidProsjektNr] <> null))",
      "in",
      "    #\"Filtered Rows\""
    ]
  }
}